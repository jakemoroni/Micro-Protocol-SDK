# Copyright (C) 2022 Jacob Moroni (opensource@jakemoroni.com).
# SPDX-License-Identifier: GPL-3.0-or-later
# Makefile to build the application.

# Set TARGET to either TARGET_UNO or TARGET_MEGA.
TARGET			:= TARGET_UNO
#TARGET			:= TARGET_MEGA

ifeq ($(TARGET), TARGET_MEGA)
	MCU			:= atmega2560
	EEPROM_MAC_OFFSET	:= 4090
	FIRMWARE_IMAGE_SIZE	:= 253952
else
	MCU			:= atmega328p
	EEPROM_MAC_OFFSET	:= 1018
	FIRMWARE_IMAGE_SIZE	:= 28672
endif

CROSS_COMPILE	:= avr-
#CROSS_COMPILE	:= /home/jmoroni/Programs/avr_toolchain/bin/avr-

BUILD_DIR	:= ./build
SRC_DIR		:= ./src

CFLAGS		:= -mmcu=$(MCU)
CFLAGS		+= -MMD -MP
CFLAGS		+= -Wall
CFLAGS		+= -Wstrict-prototypes
CFLAGS		+= -Os
CFLAGS		+= -fshort-enums
CFLAGS		+= -ffunction-sections
CFLAGS		+= -fdata-sections
CFLAGS		+= -DEEPROM_MAC_OFFSET=$(EEPROM_MAC_OFFSET)
CFLAGS		+= -DFIRMWARE_IMAGE_SIZE=$(FIRMWARE_IMAGE_SIZE)

LDFLAGS		:= -mmcu=$(MCU) -Wl,-gc-sections,--relax

ASM_SRCS	:= $(wildcard $(SRC_DIR)/*.S)
C_SRCS		:= $(wildcard $(SRC_DIR)/*.c)
OBJS		:= $(filter %.o, \
			$(patsubst $(SRC_DIR)/%.S,$(BUILD_DIR)/%.o,$(ASM_SRCS)) \
			$(patsubst $(SRC_DIR)/%.c,$(BUILD_DIR)/%.o,$(C_SRCS)))

all:	application.update

# Compile ASM files.
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.S | $(BUILD_DIR)
	$(CROSS_COMPILE)gcc -c -o $@ $(CFLAGS) $<

# Compile C files.
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c | $(BUILD_DIR)
	$(CROSS_COMPILE)gcc -c -o $@ $(CFLAGS) $<

application.elf: $(OBJS)
	$(CROSS_COMPILE)gcc -o $@ $(OBJS) $(LDFLAGS)

application.bin: application.elf
	@$(CROSS_COMPILE)objcopy -O binary $< $@
	$(info Program size:)
	@$(CROSS_COMPILE)size $<

genimage: genimage.c
	@$(CC) -o $@ $< -Wall

application.update: application.bin genimage
	@./genimage $(FIRMWARE_IMAGE_SIZE) application.bin > $@

$(BUILD_DIR):
	@mkdir $@

.PHONY: clean
clean:
	@rm -rf application.elf application.bin $(BUILD_DIR) genimage application.update

# Incorporate header deps, generated by GCC with -MMD -MP.
-include $(OBJS:%.o=%.d)
